<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¹å™¨ç®¡ç†</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body class="admin-body">
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-mark"></div>
                <div class="brand-title">NapCat</div>
                <div class="brand-sub">Bot ç®¡ç†</div>
            </div>
            <div class="nav">
                <div class="nav-group-title">åŸºç¡€ä¿¡æ¯</div>
                <a class="nav-item active" href="/container-manager.html">
                    <span class="nav-icon">ğŸ“¦</span>
                    <span>å®¹å™¨ç®¡ç†</span>
                </a>
                <a class="nav-item" href="/bot-config.html">
                    <span class="nav-icon">ğŸ¤–</span>
                    <span>Bot é…ç½®</span>
                </a>
            </div>
            <div class="sidebar-footer">
                <button class="nav-item" type="button" onclick="toggleTheme()" id="themeBtn">
                    <span class="nav-icon">ğŸŒ—</span>
                    <span>åˆ‡æ¢ä¸»é¢˜</span>
                </button>
                <button class="nav-item logout" type="button" onclick="logout()">
                    <span class="nav-icon">â‹</span>
                    <span>é€€å‡º</span>
                </button>
            </div>
        </aside>
        <main class="main">
            <header class="topbar">
                <div class="topbar-title">
                    <div class="topbar-h1">å®¹å™¨ç®¡ç†</div>
                    <div class="topbar-sub">ç®¡ç†æœåŠ¡å™¨ä¸Šçš„ Docker å®¹å™¨</div>
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-refresh" type="button" onclick="loadContainers()">åˆ·æ–°</button>
                    <button class="btn btn-add" type="button" onclick="openAddBotModal()">æ–°å»ºæœºå™¨äºº</button>
                    <button class="btn btn-password" type="button" onclick="openPasswordModal()">ä¿®æ”¹å¯†ç </button>
                </div>
            </header>
            <section class="page">
                <div id="containerCards" class="cards"></div>
            </section>
        </main>
    </div>

    <div id="addBotMask" class="modal-mask">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ æœºå™¨äºº</div>
                <button class="modal-close" onclick="closeAddBotModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="botAccount">QQå·</label>
                    <input id="botAccount" placeholder="ä¾‹å¦‚ï¼š123456789" inputmode="numeric" />
                </div>
                <div class="form-row">
                    <label for="botPort">WebUIç«¯å£</label>
                    <input id="botPort" placeholder="ä¾‹å¦‚ï¼š6099" inputmode="numeric" />
                </div>
                <div class="form-row">
                    <label for="wsPort">WSç«¯å£</label>
                    <input id="wsPort" placeholder="ä¾‹å¦‚ï¼š8081" inputmode="numeric" />
                </div>
                <div class="form-row">
                    <label for="serverIp">æœåŠ¡å™¨IP</label>
                    <input id="serverIp" placeholder="è¾“å…¥ä½ çš„å…¬ç½‘IPåœ°å€" />
                </div>
                <div class="form-row">
                    <label for="accessToken">Token</label>
                    <input id="accessToken" value="1024*1024*1024" />
                </div>
                <div class="form-row">
                    <label for="groupId">ä¿®ç‚¼ç¾¤å·</label>
                    <input id="groupId" placeholder="ä¾‹å¦‚ï¼š971297429" inputmode="numeric" />
                </div>
                <div class="form-row">
                    <label for="controlQQ">ä¸»å·QQ</label>
                    <input id="controlQQ" placeholder="ä¾‹å¦‚ï¼š819463350" inputmode="numeric" />
                </div>
                <div class="hint">
                    å®¹å™¨åå°†è‡ªåŠ¨ç”Ÿæˆï¼šQQå·-WebUIç«¯å£ã€‚<br/>
                    WebUIç«¯å£ä¼šæ˜ å°„ä¸ºï¼šæœ¬æœºç«¯å£ -> 6099ã€‚<br/>
                    WSç«¯å£ç”¨äºåå‘WebSocketè¿æ¥ã€‚
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAddBotModal()">å–æ¶ˆ</button>
                <button class="btn btn-add" onclick="submitAddBot()">ç¡®è®¤åˆ›å»º</button>
            </div>
        </div>
    </div>

    <div id="passwordMask" class="modal-mask">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ä¿®æ”¹å¯†ç </div>
                <button class="modal-close" onclick="closePasswordModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="oldPassword">åŸå¯†ç </label>
                    <input id="oldPassword" type="password" autocomplete="current-password" />
                </div>
                <div class="form-row">
                    <label for="newPassword">æ–°å¯†ç </label>
                    <input id="newPassword" type="password" autocomplete="new-password" />
                </div>
                <div class="form-row">
                    <label for="newPassword2">ç¡®è®¤æ–°å¯†ç </label>
                    <input id="newPassword2" type="password" autocomplete="new-password" />
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePasswordModal()">å–æ¶ˆ</button>
                <button class="btn btn-password" onclick="submitChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        var selfContainerIdPrefix = '';

        // åˆå§‹åŒ–ä¸»é¢˜
        (function() {
            var theme = localStorage.getItem('napcat_theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();

        function toggleTheme() {
            var root = document.documentElement;
            if (root.classList.contains('dark')) {
                root.classList.remove('dark');
                localStorage.setItem('napcat_theme', 'light');
            } else {
                root.classList.add('dark');
                localStorage.setItem('napcat_theme', 'dark');
            }
        }

        $(document).ready(function() {
            ensureAuthed(function() {
                initSelfContainerPrefix(function() {
                    loadContainers();
                });
            });
        });

        function initSelfContainerPrefix(cb) {
            $.ajax({
                url: '/api/docker/diagnose',
                method: 'GET',
                success: function(res) {
                    if (res && res.selfContainerIdPrefix) {
                        selfContainerIdPrefix = String(res.selfContainerIdPrefix || '');
                    }
                    if (cb) cb();
                },
                error: function() {
                    if (cb) cb();
                }
            });
        }

        function ensureAuthed(cb) {
            $.get('/api/auth/me').done(function(res) {
                if (res && res.authenticated) {
                    if (cb) cb();
                    return;
                }
                redirectToLogin();
            }).fail(function() {
                redirectToLogin();
            });
        }

        function redirectToLogin() {
            var next = window.location.pathname + (window.location.search || '');
            window.location.href = '/login.html?next=' + encodeURIComponent(next);
        }

        function safeName(container) {
            if (container.names && container.names.length) {
                return container.names.join(', ').replace(/\//g, '');
            }
            if (container.name) return String(container.name).replace(/\//g, '');
            return 'æœªå‘½åå®¹å™¨';
        }

        function isPinnedContainer(container) {
            var id = container.id || container.Id || '';
            if (selfContainerIdPrefix && id && String(id).indexOf(selfContainerIdPrefix) === 0) return true;
            var name = safeName(container).toLowerCase();
            return name.indexOf('java-bot') >= 0 || name.indexOf('javabot') >= 0;
        }

        function formatPorts(ports) {
            if (!ports || !ports.length) return 'â€”';
            var seen = {};
            var out = [];
            ports.forEach(function(p) {
                var privatePort = p.privatePort != null ? p.privatePort : p.PrivatePort;
                var publicPort = p.publicPort != null ? p.publicPort : p.PublicPort;
                if (privatePort == null) return;
                var key = String(privatePort) + '|' + (publicPort == null ? '' : String(publicPort));
                if (seen[key]) return;
                seen[key] = true;
                if (publicPort != null) out.push(privatePort + '->' + publicPort);
                else out.push(String(privatePort));
            });
            return out.join(', ');
        }

        function findNapcatWebUiPort(ports) {
            if (!ports || !ports.length) return null;
            for (var i = 0; i < ports.length; i++) {
                var p = ports[i];
                var privatePort = p.privatePort != null ? p.privatePort : p.PrivatePort;
                var publicPort = p.publicPort != null ? p.publicPort : p.PublicPort;
                var type = p.type != null ? p.type : p.Type;
                if (Number(privatePort) === 6099 && publicPort != null && (!type || String(type).toLowerCase() === 'tcp')) {
                    return Number(publicPort);
                }
            }
            return null;
        }

        function openNapcatWebUi(port) {
            if (!port) return;
            var protocol = window.location.protocol || 'http:';
            var host = window.location.hostname;
            var url = protocol + '//' + host + ':' + port + '/';
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function loadContainers() {
            $('#containerCards').html('<div class="loading">åŠ è½½ä¸­...</div>');
            $.ajax({
                url: '/api/docker/containers',
                method: 'GET',
                success: function(containers) {
                    var html = '';
                    if (!containers || containers.length === 0) {
                        $('#containerCards').html('<div class="empty">æ²¡æœ‰æ‰¾åˆ°å®¹å™¨</div>');
                        return;
                    }
                    containers = containers.slice().sort(function(a, b) {
                        var ap = isPinnedContainer(a);
                        var bp = isPinnedContainer(b);
                        if (ap === bp) return 0;
                        return ap ? -1 : 1;
                    });
                    containers.forEach(function(container) {
                        var id = container.id || container.Id || '';
                        var state = container.state || container.State || '';
                        var status = container.status || container.Status || '';
                        var portsText = formatPorts(container.ports);
                        var napcatWebUiPort = findNapcatWebUiPort(container.ports);
                        var chipClass = state === 'running' ? 'chip-running' : 'chip-exited';
                        var title = safeName(container);

                        html += '<div class="card">';
                        html +=   '<div class="card-top">';
                        html +=     '<div>';
                        html +=       '<div class="card-title">' + title + '</div>';
                        html +=       '<div class="card-sub">ç«¯å£ï¼š' + portsText + '</div>';
                        html +=     '</div>';
                        html +=     '<div class="chip ' + chipClass + '">' + (state || 'unknown') + '</div>';
                        html +=   '</div>';
                        html +=   '<div class="card-sub">' + (status || '') + '</div>';
                        html +=   '<div class="card-actions">';
                        if (napcatWebUiPort) {
                            html += '<button class="btn btn-webui" onclick="openNapcatWebUi(' + napcatWebUiPort + ')">WebUI</button>';
                        }
                        html +=     '<button class="btn btn-restart" onclick="restartContainer(\'' + id + '\')">é‡å¯</button>';
                        if (state === 'running') {
                            html += '<button class="btn btn-stop" onclick="stopContainer(\'' + id + '\')">åœæ­¢</button>';
                        }
                        html +=     '<button class="btn btn-delete" onclick="removeContainer(\'' + id + '\')">åˆ é™¤</button>';
                        html +=   '</div>';
                        html += '</div>';
                    });
                    $('#containerCards').html(html);
                },
                error: function(err) {
                    console.error(err);
                    var errMsg = 'æœªçŸ¥é”™è¯¯';
                    if (err.responseJSON) {
                        if (err.responseJSON.message) {
                            errMsg = err.responseJSON.message;
                        } 
                        else if (err.responseJSON.error) {
                            errMsg = err.responseJSON.error;
                        }
                    } else if (err.statusText && err.statusText !== 'error') {
                        errMsg = err.statusText;
                    }
                    $('#containerCards').html('<div class="error">åŠ è½½å¤±è´¥ï¼š' + errMsg + '<br/><small style="color:gray">(è¯·å°è¯•é‡å¯åº”ç”¨ä»¥åŠ è½½æœ€æ–°ä¿®å¤ä»£ç )</small></div>');
                }
            });
        }

        function openAddBotModal() {
            $('#botAccount').val('');
            $('#botPort').val('');
            $('#wsPort').val('');
            $('#serverIp').val('');
            $('#accessToken').val('1024*1024*1024');
            $('#groupId').val('');
            $('#controlQQ').val('');
            $('#addBotMask').css('display', 'flex');
        }

        function closeAddBotModal() {
            $('#addBotMask').hide();
        }

        function submitAddBot() {
            var account = String($('#botAccount').val() || '').trim();
            var portStr = String($('#botPort').val() || '').trim();
            var wsPortStr = String($('#wsPort').val() || '').trim();
            var serverIp = String($('#serverIp').val() || '').trim();
            var accessToken = String($('#accessToken').val() || '').trim();
            var groupId = String($('#groupId').val() || '').trim();
            var controlQQ = String($('#controlQQ').val() || '').trim();

            if (!/^\d{5,12}$/.test(account)) {
                alert('QQå·æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            if (!/^\d+$/.test(portStr)) {
                alert('WebUIç«¯å£æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            if (!/^\d+$/.test(wsPortStr)) {
                alert('WSç«¯å£æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            if (!serverIp) {
                alert('è¯·è¾“å…¥æœåŠ¡å™¨IP');
                return;
            }
            if (!groupId) {
                alert('è¯·è¾“å…¥ä¿®ç‚¼ç¾¤å·');
                return;
            }
            if (!controlQQ) {
                alert('è¯·è¾“å…¥ä¸»å·QQ');
                return;
            }

            var hostPort = parseInt(portStr, 10);
            if (hostPort < 1 || hostPort > 65535) {
                alert('WebUIç«¯å£èŒƒå›´åº”ä¸º 1-65535');
                return;
            }
            var wsPort = parseInt(wsPortStr, 10);
            if (wsPort < 1 || wsPort > 65535) {
                alert('WSç«¯å£èŒƒå›´åº”ä¸º 1-65535');
                return;
            }

            $.ajax({
                url: '/api/docker/napcat',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    account: account, 
                    hostPort: hostPort,
                    wsPort: wsPort,
                    serverIp: serverIp,
                    accessToken: accessToken,
                    groupId: groupId,
                    controlQQ: controlQQ
                }),
                success: function(res) {
                    alert('åˆ›å»ºæˆåŠŸï¼š' + (res.containerName || ''));
                    closeAddBotModal();
                    loadContainers();
                },
                error: function(err) {
                    if (err && err.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    var msg = err && err.responseJSON && err.responseJSON.message ? err.responseJSON.message : (err.statusText || 'error');
                    alert('åˆ›å»ºå¤±è´¥: ' + msg);
                }
            });
        }

        function openPasswordModal() {
            $('#oldPassword').val('');
            $('#newPassword').val('');
            $('#newPassword2').val('');
            $('#passwordMask').css('display', 'flex');
        }

        function closePasswordModal() {
            $('#passwordMask').hide();
        }

        function submitChangePassword() {
            var oldPassword = String($('#oldPassword').val() || '');
            var newPassword = String($('#newPassword').val() || '');
            var newPassword2 = String($('#newPassword2').val() || '');
            if (!newPassword || newPassword.length < 4) {
                alert('æ–°å¯†ç è‡³å°‘ 4 ä½');
                return;
            }
            if (newPassword !== newPassword2) {
                alert('ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            $.ajax({
                url: '/api/auth/change-password',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ oldPassword: oldPassword, newPassword: newPassword }),
                success: function(res) {
                    alert(res && res.message ? res.message : 'å¯†ç å·²æ›´æ–°');
                    closePasswordModal();
                },
                error: function(err) {
                    if (err && err.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    var msg = err && err.responseJSON && err.responseJSON.message ? err.responseJSON.message : (err.statusText || 'error');
                    alert('ä¿®æ”¹å¤±è´¥: ' + msg);
                }
            });
        }

        function logout() {
            $.ajax({
                url: '/api/auth/logout',
                method: 'POST',
                success: function() {
                    redirectToLogin();
                },
                error: function() {
                    redirectToLogin();
                }
            });
        }

        function restartContainer(id) {
            if(!confirm('ç¡®å®šè¦é‡å¯è¯¥å®¹å™¨å—ï¼Ÿ')) return;
            $.ajax({
                url: '/api/docker/containers/' + id + '/restart',
                method: 'POST',
                success: function(res, textStatus, xhr) {
                    var statusCode = xhr && xhr.status ? xhr.status : 200;
                    var msg = (res && res.message) ? res.message : 'é‡å¯è¯·æ±‚å·²æäº¤';
                    alert(msg);
                    if (statusCode === 202) {
                        waitForServiceRecovery(60);
                    } else {
                        loadContainers();
                    }
                },
                error: function(err) {
                    if (err && err.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    alert('é‡å¯å¤±è´¥: ' + (err.responseJSON ? err.responseJSON.message : err.statusText));
                }
            });
        }

        function waitForServiceRecovery(maxSeconds) {
            var startedAt = Date.now();
            function poll() {
                var elapsedSeconds = Math.floor((Date.now() - startedAt) / 1000);
                if (elapsedSeconds >= maxSeconds) {
                    return;
                }
                $.ajax({
                    url: '/api/docker/diagnose',
                    method: 'GET',
                    success: function(res) {
                        if (res && res.ping === 'OK') {
                            loadContainers();
                            return;
                        }
                        setTimeout(poll, 1000);
                    },
                    error: function() {
                        setTimeout(poll, 1000);
                    }
                });
            }
            setTimeout(poll, 1000);
        }

        function stopContainer(id) {
            if(!confirm('ç¡®å®šè¦åœæ­¢è¯¥å®¹å™¨å—ï¼Ÿ')) return;
            $.ajax({
                url: '/api/docker/containers/' + id + '/stop',
                method: 'POST',
                success: function(res) {
                    alert('åœæ­¢æˆåŠŸ');
                    loadContainers();
                },
                error: function(err) {
                    if (err && err.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    alert('åœæ­¢å¤±è´¥: ' + (err.responseJSON ? err.responseJSON.message : err.statusText));
                }
            });
        }

        function removeContainer(id) {
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å®¹å™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) return;
            $.ajax({
                url: '/api/docker/containers/' + id,
                method: 'DELETE',
                success: function(res) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadContainers();
                },
                error: function(err) {
                    if (err && err.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    alert('åˆ é™¤å¤±è´¥: ' + (err.responseJSON ? err.responseJSON.message : err.statusText));
                }
            });
        }
    </script>
</body>
</html>
