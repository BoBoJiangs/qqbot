<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQ Bot 配置管理</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body class="admin-body">
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-mark"></div>
                <div class="brand-title">NapCat</div>
                <div class="brand-sub">Bot 管理</div>
            </div>
            <div class="nav">
                <div class="nav-group-title">基础信息</div>
                <a class="nav-item" href="/container-manager.html">
                    <span class="nav-icon">📦</span>
                    <span>容器管理</span>
                </a>
                <a class="nav-item active" href="/bot-config.html">
                    <span class="nav-icon">🤖</span>
                    <span>Bot 配置</span>
                </a>
            </div>
            <div class="sidebar-footer">
                <button class="nav-item" type="button" onclick="toggleTheme()" id="themeBtn">
                    <span class="nav-icon">🌗</span>
                    <span>切换主题</span>
                </button>
                <button class="nav-item logout" type="button" onclick="logout()">
                    <span class="nav-icon">⎋</span>
                    <span>退出</span>
                </button>
            </div>
        </aside>
        <main class="main">
            <header class="topbar">
                <div class="topbar-title">
                    <div class="topbar-h1">Bot 配置管理</div>
                    <div class="topbar-sub">可视化配置管理界面</div>
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-primary" type="button" onclick="saveConfig()">保存</button>
                    <button class="btn btn-success" type="button" onclick="loadConfig()">刷新</button>
                    <button class="btn btn-warning" type="button" onclick="resetConfig()">重置</button>
                    <button class="btn" type="button" onclick="exportConfig()">导出</button>
                    <button class="btn" type="button" onclick="showImportModal()">导入</button>
                </div>
            </header>
            <section class="page">
                <div class="panel">
                    <div class="panel-inner">
                        <div class="bot-selector">
                            <h3>选择要配置的Bot</h3>
                            <div class="bot-list" id="botList">
                                <div class="loading">正在加载Bot列表...</div>
                            </div>
                        </div>

                        <div class="config-section" id="configSection">
                            <div class="config-tabs">
                                <button class="tab active" onclick="showTab('basic')">基础配置</button>
                                <button class="tab" onclick="showTab('reward')">悬赏令配置</button>
                                <button class="tab" onclick="showTab('cultivation')">修炼配置</button>
                                <button class="tab" onclick="showTab('sect')">宗门配置</button>
                                <button class="tab" onclick="showTab('query')">查询功能</button>
                                <button class="tab" onclick="showTab('control')">控制配置</button>
                                <button class="tab" onclick="showTab('runtime')">运行时状态</button>
                            </div>

                <!-- 基础配置 -->
                <div id="basic" class="tab-content">
                    <h3>基础配置</h3>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>Bot编号</label>
                            <input type="number" id="botNumber" placeholder="设置Bot编号">
                        </div>
                        <div class="form-group">
                            <label>AI称呼</label>
                            <input type="text" id="aiCheng" placeholder="设置AI的自称">
                        </div>
                    </div>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>验证模式</label>
                            <select id="autoVerifyModel">
                                <option value="0">手动验证</option>
                                <option value="1">半自动验证</option>
                                <option value="2">全自动验证</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row-grid">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableAutoTask">
                            <label for="enableAutoTask">启用定时任务</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableAutomaticReply">
                            <label for="enableAutomaticReply">启用群消息自动回复</label>
                        </div>
                    </div>
                </div>

                <!-- 悬赏令配置 -->
                <div id="reward" class="tab-content" style="display: none;">
                    <h3>悬赏令配置</h3>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>悬赏令模式</label>
                            <select id="rewardMode">
                                <option value="1">手动模式</option>
                                <option value="2">半自动模式</option>
                                <option value="3">全自动价值优先</option>
                                <option value="4">全自动时长最短</option>
                                <option value="5">全自动修为最高</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>价格限制 (万)</label>
                            <input type="number" id="xslPriceLimit" placeholder="悬赏令价格限制">
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="enableXslPriceQuery">
                        <label for="enableXslPriceQuery">启用悬赏令价格查询</label>
                    </div>
                </div>

                <!-- 修炼配置 -->
                <div id="cultivation" class="tab-content" style="display: none;">
                    <h3>修炼配置</h3>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>修炼模式</label>
                            <select id="cultivationMode">
                                <option value="0">无</option>
                                <option value="1">修炼</option>
                                <option value="2">普通闭关</option>
                                <option value="3">宗门闭关</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="enableAutoRepair">
                        <label for="enableAutoRepair">启用无偿双修</label>
                    </div>
                </div>

                <!-- 宗门配置 -->
                <div id="sect" class="tab-content" style="display: none;">
                    <h3>宗门配置</h3>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>宗门任务模式</label>
                            <select id="sectMode">
                                <option value="1">邪修查抄</option>
                                <option value="2">所有任务</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row-grid">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableSectMission">
                            <label for="enableSectMission">启用宗门任务</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableAutoField">
                            <label for="enableAutoField">启用自动灵田结算</label>
                        </div>
                    </div>
                </div>

                <!-- 查询功能 -->
                <div id="query" class="tab-content" style="display: none;">
                    <h3>查询功能</h3>
                    <div class="form-row-grid">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableCheckPrice">
                            <label for="enableCheckPrice">启用价格查询</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enableGuessTheIdiom">
                            <label for="enableGuessTheIdiom">启用猜成语查询</label>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="enableAutoSecret">
                        <label for="enableAutoSecret">启用自动秘境结算</label>
                    </div>
                </div>

                <!-- 控制配置 -->
                <div id="control" class="tab-content" style="display: none;">
                    <h3>控制配置</h3>
                    <div class="form-row-grid">
                        <div class="form-group">
                            <label>主号QQ</label>
                            <input type="text" id="controlQQ" placeholder="控制QQ号，多个用&分隔">
                        </div>
                        <div class="form-group">
                            <label>提醒群号</label>
                            <input type="text" id="groupQQ" placeholder="提醒群号，多个用&分隔">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>赠送灵石群号</label>
                        <input type="number" id="lingShiQQ" placeholder="赠送灵石的群号">
                    </div>
                </div>

                <!-- 运行时状态 -->
                <div id="runtime" class="tab-content" style="display: none;">
                    <h3>运行时状态</h3>
                    <div class="runtime-status">
                        <h4>当前状态</h4>
                        <div class="status-grid" id="runtimeStatus">
                            <div class="loading">正在加载状态信息...</div>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="importModal" class="modal-mask">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">导入配置</div>
                <button class="modal-close" type="button" onclick="closeImportModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="field">
                    <label for="importConfig">配置 JSON</label>
                    <textarea id="importConfig" rows="10" placeholder="请粘贴配置JSON内容..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" type="button" onclick="closeImportModal()">取消</button>
                <button class="btn btn-primary" type="button" onclick="importConfig()">导入</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化主题
        (function() {
            var theme = localStorage.getItem('napcat_theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();

        function toggleTheme() {
            var root = document.documentElement;
            if (root.classList.contains('dark')) {
                root.classList.remove('dark');
                localStorage.setItem('napcat_theme', 'light');
            } else {
                root.classList.add('dark');
                localStorage.setItem('napcat_theme', 'dark');
            }
        }

        function redirectToLogin() {
            const next = window.location.pathname + (window.location.search || '');
            window.location.href = '/login.html?next=' + encodeURIComponent(next);
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
            } catch (e) {
            }
            redirectToLogin();
        }

        async function ensureAuthed() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
                const data = await res.json();
                if (!data || !data.authenticated) {
                    redirectToLogin();
                    return false;
                }
                return true;
            } catch (e) {
                redirectToLogin();
                return false;
            }
        }

        async function authFetch(url, options) {
            const opts = options || {};
            opts.credentials = 'same-origin';
            const res = await fetch(url, opts);
            if (res.status === 401) {
                redirectToLogin();
                throw new Error('Unauthorized');
            }
            return res;
        }

        let currentBotId = null;
        let bots = {};

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            ensureAuthed().then(ok => {
                if (ok) loadBots();
            });
        });

        // 加载Bot列表
        async function loadBots() {
            try {
                const response = await authFetch('/api/bot-config/bots');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }

                bots = data.bots;
                renderBotList();
            } catch (error) {
                showError('加载Bot列表失败: ' + error.message);
            }
        }

        // 渲染Bot列表
        function renderBotList() {
            const botList = document.getElementById('botList');
            botList.innerHTML = '';

            Object.values(bots).forEach(bot => {
                const botCard = document.createElement('div');
                botCard.className = 'bot-card';
                botCard.onclick = function() { selectBot(bot.botId, this); };
                
                botCard.innerHTML = `
                    <div class="bot-name">
                        <span class="status-indicator status-online"></span>
                        ${bot.botName}
                    </div>
                    <div class="bot-info">
                        Bot ID: ${bot.botId}<br>
                        群号: ${bot.groupId}
                    </div>
                `;
                
                botList.appendChild(botCard);
            });
        }

        // 选择Bot
        async function selectBot(botId, cardElement) {
            currentBotId = botId;
            
            // 更新UI
            document.querySelectorAll('.bot-card').forEach(card => {
                card.classList.remove('active');
            });
            if (cardElement) {
                cardElement.classList.add('active');
            }
            
            document.getElementById('configSection').classList.add('active');
            
            // 加载配置
            await loadConfig();
        }

        // 加载配置
        async function loadConfig() {
            if (!currentBotId) return;

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}`);
                const config = await response.json();
                
                if (response.status === 404) {
                    showError('Bot不存在');
                    return;
                }

                // 填充表单
                fillForm(config);
                
                // 加载运行时状态
                await loadRuntimeStatus();
                
            } catch (error) {
                showError('加载配置失败: ' + error.message);
            }
        }

        // 填充表单
        function fillForm(config) {
            const setValue = (id, value, def = '') => {
                const el = document.getElementById(id);
                if (el) el.value = (value !== null && value !== undefined) ? value : def;
            };
            const setCheck = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.checked = !!value;
            };

            setValue('botNumber', config.botNumber);
            setValue('aiCheng', config.aiCheng);
            setValue('autoVerifyModel', config.autoVerifyModel, 0);
            setCheck('enableAutoTask', config.enableAutoTask);
            setCheck('enableAutomaticReply', config.enableAutomaticReply);
            
            setValue('rewardMode', config.rewardMode, 5);
            setValue('xslPriceLimit', config.xslPriceLimit, 1000);
            setCheck('enableXslPriceQuery', config.enableXslPriceQuery);
            
            setValue('cultivationMode', config.cultivationMode, 0);
            setCheck('enableAutoRepair', config.enableAutoRepair);
            
            setValue('sectMode', config.sectMode, 1);
            setCheck('enableSectMission', config.enableSectMission);
            setCheck('enableAutoField', config.enableAutoField);
            
            setCheck('enableCheckPrice', config.enableCheckPrice);
            setCheck('enableGuessTheIdiom', config.enableGuessTheIdiom);
            setCheck('enableAutoSecret', config.enableAutoSecret);
            
            setValue('controlQQ', config.controlQQ);
            setValue('groupQQ', config.groupQQ);
            setValue('lingShiQQ', config.lingShiQQ);
        }

        // 加载运行时状态
        async function loadRuntimeStatus() {
            if (!currentBotId) return;

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}/status`);
                const status = await response.json();
                
                if (status.error) {
                    showError(status.error);
                    return;
                }

                renderRuntimeStatus(status);
            } catch (error) {
                showError('加载运行时状态失败: ' + error.message);
            }
        }

        // 渲染运行时状态
        function renderRuntimeStatus(status) {
            const statusGrid = document.getElementById('runtimeStatus');
            statusGrid.innerHTML = '';

            const statusItems = [
                { label: '停止状态', value: status.isStop ? '已停止' : '运行中', color: status.isStop ? '#dc3545' : '#28a745' },
                { label: '定时任务', value: status.isStartScheduled ? '启用' : '禁用', color: status.isStartScheduled ? '#28a745' : '#dc3545' },
                { label: '当前命令', value: status.command || '无', color: '#333' },
                { label: '验证状态', value: status.verificationStatus || '正常', color: '#333' },
                { label: '挑战模式', value: status.challengeMode || '0', color: '#333' },
                { label: '最后发送时间', value: status.lastSendTime ? new Date(status.lastSendTime).toLocaleString() : '无', color: '#333' }
            ];

            statusItems.forEach(item => {
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item';
                statusItem.innerHTML = `
                    <div class="status-label">${item.label}</div>
                    <div class="status-value" style="color: ${item.color}">${item.value}</div>
                `;
                statusGrid.appendChild(statusItem);
            });
        }

        // 保存配置
        async function saveConfig() {
            if (!currentBotId) {
                showError('请先选择一个Bot');
                return;
            }

            const config = {
                botNumber: parseInt(document.getElementById('botNumber').value) || 0,
                aiCheng: document.getElementById('aiCheng').value,
                autoVerifyModel: parseInt(document.getElementById('autoVerifyModel').value),
                enableAutoTask: document.getElementById('enableAutoTask').checked,
                enableAutomaticReply: document.getElementById('enableAutomaticReply').checked,
                rewardMode: parseInt(document.getElementById('rewardMode').value),
                xslPriceLimit: parseInt(document.getElementById('xslPriceLimit').value) || 1000,
                enableXslPriceQuery: document.getElementById('enableXslPriceQuery').checked,
                cultivationMode: parseInt(document.getElementById('cultivationMode').value),
                enableAutoRepair: document.getElementById('enableAutoRepair').checked,
                sectMode: parseInt(document.getElementById('sectMode').value),
                enableSectMission: document.getElementById('enableSectMission').checked,
                enableAutoField: document.getElementById('enableAutoField').checked,
                enableCheckPrice: document.getElementById('enableCheckPrice').checked,
                enableGuessTheIdiom: document.getElementById('enableGuessTheIdiom').checked,
                enableAutoSecret: document.getElementById('enableAutoSecret').checked,
                controlQQ: document.getElementById('controlQQ').value,
                groupQQ: document.getElementById('groupQQ').value,
                lingShiQQ: document.getElementById('lingShiQQ').value ? parseInt(document.getElementById('lingShiQQ').value) : null
            };

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                let result = {};
                try {
                    result = await response.json();
                } catch (e) {
                    result = {};
                }

                if (!response.ok) {
                    showError(result.error || `保存失败 (${response.status})`);
                    return;
                }
                
                if (result.success) {
                    showSuccess('配置保存成功！');
                    await loadConfig();
                } else {
                    showError(result.error || '保存失败');
                }
            } catch (error) {
                showError('保存配置失败: ' + error.message);
            }
        }

        // 重置配置
        async function resetConfig() {
            if (!currentBotId) {
                showError('请先选择一个Bot');
                return;
            }

            if (!confirm('确定要重置配置为默认值吗？')) {
                return;
            }

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}/reset`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('配置重置成功！');
                    await loadConfig();
                } else {
                    showError(result.error || '重置失败');
                }
            } catch (error) {
                showError('重置配置失败: ' + error.message);
            }
        }

        // 导出配置
        async function exportConfig() {
            if (!currentBotId) {
                showError('请先选择一个Bot');
                return;
            }

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}/export`);
                const result = await response.json();
                
                if (result.error) {
                    showError(result.error);
                    return;
                }

                // 创建下载链接
                const blob = new Blob([result.config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-${currentBotId}-config.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess('配置导出成功！');
            } catch (error) {
                showError('导出配置失败: ' + error.message);
            }
        }

        // 显示导入模态框
        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        // 关闭导入模态框
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importConfig').value = '';
        }

        // 导入配置
        async function importConfig() {
            if (!currentBotId) {
                showError('请先选择一个Bot');
                return;
            }

            const configJson = document.getElementById('importConfig').value.trim();
            if (!configJson) {
                showError('请输入配置JSON内容');
                return;
            }

            try {
                const response = await authFetch(`/api/bot-config/${currentBotId}/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config: configJson })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('配置导入成功！');
                    closeImportModal();
                    await loadConfig();
                } else {
                    showError(result.error || '导入失败');
                }
            } catch (error) {
                showError('导入配置失败: ' + error.message);
            }
        }

        // 显示标签页
        function showTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // 移除所有标签的active类
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName).style.display = 'block';
            
            // 添加active类到选中的标签
            event.target.classList.add('active');
        }

        // 显示错误信息
        function showError(message) {
            showToast(message, 'error');
        }

        // 显示成功信息
        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showToast(message, type) {
            let container = document.getElementById('toastStack');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastStack';
                container.className = 'toast-stack';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = 'toast ' + (type === 'success' ? 'toast-success' : 'toast-error');
            toast.textContent = message;
            container.appendChild(toast);

            const ttl = type === 'success' ? 3000 : 5000;
            setTimeout(() => {
                toast.remove();
                if (container.childElementCount === 0) {
                    container.remove();
                }
            }, ttl);
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('importModal');
            if (event.target === modal) {
                closeImportModal();
            }
        }
    </script>
</body>
</html>
