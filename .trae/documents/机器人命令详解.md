# 机器人命令详解

本项目的“命令”主要来自以下模块：
- 综合命令（大多数开关/模式/掌门体系）：[TestService.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java)
- 捡漏（坊市循环查看与低价购买）：[AutoBuyGoods.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/AutoBuyGoods.java)
- 批量上架药材：[AutoSellGoods.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/AutoSellGoods.java)
- 炼丹菜单与自动炼丹：[AutoAlchemyTask.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/liandan/AutoAlchemyTask.java)
- 炼丹采购药材：[AutoBuyHerbs.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/liandan/AutoBuyHerbs.java)
- 定时任务：[SchedulerTask.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/SchedulerTask.java)
- 小北体系：[XiaoBeiService.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/XiaoBeiService.java)
- 运维与状态：[MemoryCleaner.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/MemoryCleaner.java)
- 群/统计管理：[GroupManager.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/GroupManager.java)

## 0. 命令触发规则（很重要）
### 0.1 普通命令（“命令/当前设置/开关”这类）
多数命令处理函数使用 `ignoreItself = ONLY_ITSELF`，并配合 `Utils.isAtSelf(...)` 判断是否“指向当前机器人”。

简化理解：
- 在“自己的修炼群”（`groupId == botConfig.groupId`）里通常可以直接发命令。
- 在其它群里通常需要消息里包含“机器人QQ号”（例如包含 `3860863656` 这类数字），也能触发（见 [Utils.isAtSelf](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/utils/Utils.java#L24-L32)）。

### 0.2 掌门/弟子体系（执行/听令/循环执行）
这类命令的处理函数标记了 `isAt = true`，含义是：需要“@机器人”才能进入解析（见 [执行命令](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1702-L1795)）。

并且，还需要“控制者身份”：
- 若配置了 `botConfig.controlQQ`（允许多个，用 `&` 分隔），则发命令的人 QQ 必须在列表中；
- 否则必须等于 `botConfig.masterQQ`（见 [checkControlQQ](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1881-L1883)）。

## 1. 入口命令（菜单/状态）
- `命令`
  - 作用：输出主菜单（功能设置/快捷命令/掌门命令/其它设置），见 [showReplyMessage](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L968-L1020)
- `当前设置`
  - 作用：输出当前机器人开关与模式状态，见 [showReplyMessage](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1021-L1081)
- `听令帮助`
  - 作用：输出掌门/弟子/循环执行说明文本，见 [听令帮助文本](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L373-L376)

## 2. 常用开关与模式（直接发送）
### 2.1 悬赏/秘境/宗门/修炼
- `开始自动悬赏`
- `开始自动秘境`
- `开始自动宗门任务`
- `开始自动修炼`
- `停止自动修炼`
- `修炼模式 <0|1|2|3>`
  - 0：什么都不干
  - 1：修炼
  - 2：普通闭关
  - 3：宗门闭关
  - 示例：`修炼模式 1`
- `悬赏令模式 <1|2|3>`
  - 1：手动
  - 2：手动接取自动结算（半自动）
  - 3：全自动（默认价值优先，代码里还支持修为/时长最短优先）
  - 示例：`悬赏令模式 3`
- `设置宗门任务 <1|2>`
  - 1：邪修和查抄（默认）
  - 2：所有任务

### 2.2 价格/查询/提醒
- `启用价格查询` / `关闭价格查询`
- `启用猜成语查询` / `关闭猜成语查询`
- `启用悬赏令价格查询` / `关闭悬赏令价格查询`
- `启用本群悬赏令价格查询` / `关闭本群悬赏令价格查询`
- `启用结算提醒` / `关闭结算提醒`
- `启用本群结算提醒` / `关闭本群结算提醒`
- `悬赏优先价值` / `悬赏优先修为` / `悬赏优先时长最短`
- `悬赏价格限制 <数字>`
  - 单位：万
  - 示例：`悬赏价格限制 1000`

### 2.3 其它常用开关
- `启用无偿双修` / `关闭无偿双修`
- `启用自动秘境` / `关闭自动秘境`
- `开启图片保存`
- `开启自助头衔` / `关闭自助头衔`
- `启用定时任务` / `关闭定时任务`
- `开启妖塔挑战` / `开始妖塔挑战` / `停止妖塔挑战`

## 3. 快捷动作（直接发送）
- `查看悬赏令`
  - 作用：向小小发送 `悬赏令`
- `确认一键丹药炼金`
- `确认一键装备炼金`
- `确认一键药材上架`
- `批量上架药材`
- `停止执行`
- `一键使用追捕令`
- `一键使用次元之钥`
- `取消一键使用...`

说明：上述“一键确认”通常会设置 `botConfig.command` 并触发背包查询，然后通过“回复背包消息”继续流程（见 [一键炼金上架](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1119-L1147)）。

## 4. 定时任务（多行命令）
由 [SchedulerTask.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/SchedulerTask.java#L26-L86) 提供。

- `设置定时任务`（必须多行）
  - 格式：第一行是“设置定时任务”，从第二行开始每行一条任务：
    - `<HH:mm> <内容>`
  - 示例：
    ```
    设置定时任务
    07:30 @3889001741 修炼
    12:35 @3889001741 探索秘境
    23:30 开始捡漏 频率1 装备&技能
    ```
- `查询定时任务`
- `移除定时任务 HH:mm`
  - 示例：`移除定时任务 12:30`
- `清空定时任务`

## 5. 捡漏（坊市循环查看）
来自 AutoBuyGoods（命令详见聊天“命令”菜单中的捡漏项）。

- `开始捡漏 频率N <动作1&动作2&...>`
  - 示例：`开始捡漏 频率1 装备&技能&丹药`
- `停止捡漏`

## 6. 炼丹相关（建议先发“炼丹命令”看菜单）
### 6.1 炼丹菜单与自动炼丹
来自 AutoAlchemyTask。

- `炼丹命令`：输出炼丹菜单
- `炼丹设置`：输出当前炼丹配置
- `开始自动炼丹` / `停止自动炼丹`
- `查询炼丹配方` / `查询药材价格`
- `查丹方...`
- `更新炼丹配置...`

### 6.2 采购药材
来自 AutoBuyHerbs。

- `开始采购药材` / `一键采购药材` / `停止采购药材`
- `采购药材<药材> <万价>`（可多行）
  - 示例：
    ```
    采购药材乌灵参 80
    采购药材血灵芝 120
    ```
- `取消采购药材<药材>`
- `批量取消采购药材`
- `查询采购药材`
- `刷新指定药材坊市 <i&j&k...>`
- `取消刷新指定药材坊市`
- `批量修改性平价格 <数字>`

## 7. 小北体系
来自 XiaoBeiService。

- `小北命令` / `小北当前设置`
- `开始小北自动宗门任务` / `停止小北自动宗门任务`
- `启用小北自动宗门任务` / `关闭小北自动宗门任务`
- `启用小北自动悬赏` / `关闭小北自动悬赏`
- `启用小北自动秘境` / `关闭小北自动秘境`
- `开始小北自动悬赏` / `开始小北自动秘境`
- `小北修炼模式 <数字>`
- `小北自动药材上架` / `确认药材上架`
- `#xxx`（控制号限定）
  - 作用：以 `#` 开头的消息会转发给小北（常用于快速下发小北查询/命令）

## 8. 运维/统计（管理员命令）
### 8.1 系统/内存
来自 MemoryCleaner。

- `*系统状态`
- `*版本号`
- `*清理内存`
- `*清理聊天记录`
- `*清理聊天记录保留最近 N 条`
- `*重启自身`

### 8.2 统计/名单/排除列表
来自 GroupManager。

- `任务统计` / `重置任务统计`
- `验证统计` / `重置验证统计`
- `添加自动验证@QQ` / `移除自动验证@QQ`
- `查看上架排除物品` / `添加上架排除物品...` / `移除上架排除物品...`
- `查看炼金排除物品` / `添加炼金排除物品...` / `移除炼金排除物品...`

## 9. 掌门/弟子/循环执行（详解）
这一部分对应“控制多个号批量下发命令”，是最常用也最容易写错的命令体系。

### 9.1 执行 / 执行命令
前提：需要 @机器人，且发消息的人是控制者（见 0.2）。

- `执行 <内容>`
  - 机器人会自动在消息前加上 `@小小(3889001741)` 再发出去（见 [执行](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1770-L1780)）。
  - 示例（@机器人后发送）：
    - `执行 修炼`
    - `执行 悬赏令`
- `执行命令 <内容>`
  - 不会自动 @小小，直接把内容发出去（见 [执行命令](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1767-L1770)）。
  - 示例：
    - `执行命令 我的状态`

### 9.2 循环执行（附加次数/间隔参数）
循环命令的参数放在“消息最后两行”：
- 倒数第 2 行：循环次数（整数）
- 倒数第 1 行：间隔秒数（整数）

#### 9.2.1 循环执行（会自动 @小小）
（@机器人后发送）
```
循环执行 修炼
10
5
```
含义：每 5 秒执行一次，共 10 次。

#### 9.2.2 循环执行命令（不自动 @小小）
（@机器人后发送）
```
循环执行命令 我的状态
5
10
```

### 9.3 听令1/2/3（对单号下发）
这组命令是“被控制的弟子号”在收到后执行：
- `听令1`：不 @小小，直接发内容
- `听令2`：自动 @小小
- `听令3`：自动 @小北（3889029313）

示例（对某个弟子号发）：
- `听令2 修炼`
- `听令3 查询世界BOSS 玄武`

### 9.4 编号/爱称听令（不需要 @机器人）
每个号有自己的 `编号(botNumber)` 和可选 `爱称(aiCheng)`，控制者可直接在群里用“前缀+命令”的方式指挥某个号执行（见 [听令执行](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1840-L1877)）。

格式：
- `<编号><命令>`
- `<爱称><命令>`

示例：
- `1 听令2 修炼`
- `小徒弟 听令1 我的状态`

### 9.5 编号听令循环执行（写成多行）
格式（以“听令2循环执行”为例，最后两行仍然是次数/间隔秒数）：
```
听令2循环执行 修炼
20
3
```

支持：
- `听令1循环执行 ...`
- `听令2循环执行 ...`
- `听令3循环执行 ...`

### 9.6 弟子听令：指定编号集合执行
格式：
- `弟子1.3.5听令 <后续命令>`

示例：
- `弟子1.3听令 听令2 修炼`
含义：让 1 号与 3 号弟子执行“听令2 修炼”。

### 9.7 弟子听令执行：控制所有账号批量执行
前提：控制者身份。

- `弟子听令执行 <内容>`：自动 @小小 执行
- `弟子听令执行命令 <内容>`：不 @小小 直接执行
- `弟子听令5执行 <内容>`：带延迟批量执行
  - 这里的 `5` 表示“每个号之间的延迟步长（秒）”，实际延迟 = `(编号-1)*5` 秒（见 [弟子执行命令](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/TestService.java#L1998-L2074)）。

示例：
- `弟子听令执行 修炼`
- `弟子听令执行命令 我的状态`
- `弟子听令5执行 修炼`

### 9.8 弟子听令循环执行：控制所有账号循环执行
格式同“循环执行”，同样把“次数/间隔秒数”放在最后两行：

（自动 @小小）
```
弟子听令循环执行 修炼
10
5
```

（不自动 @小小）
```
弟子听令循环执行命令 我的状态
5
10
```

