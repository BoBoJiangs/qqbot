# 使用说明（Java QQ Bot / Napcat 管理）

## 快速开始
- 构建：在项目根目录执行 `mvn -DskipTests package`，生成 `target/bot.jar`
- 运行：`java -jar target/bot.jar`
- 访问前端：浏览器打开 `http://localhost:6001/`，页面含“容器管理”“配置管理”等

## 配置文件
- 主配置：`src/main/resources/application.yml`（默认激活 `local`）
- 本地环境：`src/main/resources/application-local.yml`
  - 关键项：
    - `docker.host`：Docker 连接地址（`auto` 支持 Unix Socket 自动探测）
    - `napcat.image`：Napcat 镜像
    - `napcat.data-root`：数据根（用于诊断展示）
    - `napcat.qq-data-dir`：宿主机 QQ 数据目录（默认 `/root/qq_data`）
    - `napcat.napcat-config-dir`：宿主机 Napcat 配置目录（默认 `/root/napcat_config`）

## Web 接口（运维）
基础路径：`/api`

### Docker 管理（`/api/docker`）
- `GET /api/docker/containers?all=true`：列出容器
- `GET /api/docker/diagnose?reconnect=false`：Docker 诊断/状态
- `POST /api/docker/containers/{id}/restart`：重启容器
- `POST /api/docker/containers/{id}/stop`：停止容器（禁止停止本服务容器）
- `DELETE /api/docker/containers/{id}`：删除容器（禁止删除本服务容器；会移除 `config/application-local.yml` 中对应 `ws-reverse` 配置块）
- `POST /api/docker/napcat`：创建 Napcat 机器人容器
  - Body（JSON）：
    - `account`：QQ号
    - `hostPort`：Napcat WebUI 端口映射（宿主机）
    - `wsPort`：反向 WS 端口（宿主机）
    - `serverIp`：服务器 IP（写入 Napcat onebot 客户端配置）
    - `accessToken`：访问令牌
    - `groupId`：修炼群号
    - `controlQQ`：主号 QQ

创建成功返回容器信息，并把对应反向 WS 配置追加到 `config/application-local.yml` 的 `bot` 列表中。删除容器会根据容器 `WS_URL` 端口自动移除该配置块。

### 认证（`/api/auth`）
- `POST /api/auth/login`：`{ username, password }` 登录
- `GET /api/auth/me`：登录状态查询
- `POST /api/auth/logout`：退出登录
- `POST /api/auth/change-password`：`{ oldPassword, newPassword }` 修改密码

### Bot 配置（`/api/bot-config`）
- `GET /api/bot-config/all`：全部配置
- `GET /api/bot-config/{botId}`：单个配置与状态
- `PUT /api/bot-config/{botId}`：更新配置（Body: Map）
- `POST /api/bot-config/{botId}/reset`：重置默认
- `GET /api/bot-config/options`：配置项说明
- `GET /api/bot-config/{botId}/status`：运行状态
- `GET /api/bot-config/{botId}/export`：导出
- `POST /api/bot-config/{botId}/import`：导入（Body: `{ "config": "..." }`）
- `GET /api/bot-config/bots`：在线 bot 列表

## 机器人使用命令（群聊/私聊）
核心入口：发送“命令”查看主菜单；发送“当前设置”查看状态。更完整的命令格式与示例请见《机器人命令详解》。

- 开关与模式
  - `开始自动悬赏` / `停止自动悬赏`
  - `开始自动秘境` / `停止自动秘境`
  - `开始自动宗门任务` / `停止自动宗门任务`
  - `启用炼丹模块` / `关闭炼丹模块`
  - `修炼模式 <0/1/2/3>`
  - `悬赏令模式 <1/2/3>`
  - `验证模式 <0/1/2>`
  - `开始妖塔挑战` / `停止妖塔挑战`
  - `启用定时任务` / `关闭定时任务`

- 查询与设置
  - `查看悬赏令`
  - `启用悬赏令价格查询` / `关闭悬赏令价格查询`
  - `启用查行情` / `停止查行情`
  - `悬赏价格限制 <数字>`
  - `设置主号 <QQ>`、`设置提醒群号 <群号>`、`设置赠送灵石群号 <群号>`

- 自动化动作
  - `确认一键丹药炼金` / `确认一键装备炼金` / `确认一键药材上架`
  - `开始捡漏 频率N <动作1&动作2...>` / `停止捡漏`
  - `批量上架药材` / `停止执行`
  - `开始采购药材` / `一键采购药材` / `停止采购药材`
  - `采购药材<药材> <万价>`（支持多行）
  - `取消采购药材<药材>` / `批量取消采购药材` / `查询采购药材`

- 小北命令
  - `小北命令` / `小北当前设置`
  - `开始小北自动宗门任务` / `停止小北自动宗门任务`
  - `启用小北自动悬赏` / `关闭小北自动悬赏`
  - `启用小北自动秘境` / `关闭小北自动秘境`
  - `小北修炼模式 <数字>`
  - `确认药材上架` / `小北自动药材上架`
  - 以 `#` 开头的消息将转发给小北（控制号限定）

- 运维/统计
  - `*清理内存` / `*系统状态` / `*版本号`
  - `*清理聊天记录保留最近 N 条` / `*清理聊天记录`
  - `任务统计` / `重置任务统计` / `验证统计` / `重置验证统计`

完整命令菜单与参数示例可在聊天中发送“命令”“听令帮助”查看详细说明。

## 容器挂载目录
- QQ 数据：`napcat.qq-data-dir`（默认 `/root/qq_data`）
- Napcat 配置：`napcat.napcat-config-dir`（默认 `/root/napcat_config`）
创建容器时会把这两个目录挂载到容器的 `/app/.config/QQ` 与 `/app/napcat/config`。同时会生成 `onebot11_<QQ>.json` 写入到 `napcat.napcat-config-dir`。

## 常见问题
- 删除容器后反向 WS 配置未移除？
  - 删除流程会根据容器 `WS_URL` 自动移除 `config/application-local.yml` 中对应 `ws-reverse` 配置块；若容器环境变量不含该项，可手动检查并移除。
- 运行提示“之前启动的程序没有关闭”？ 
  - 默认启用了单实例锁（端口 62345），结束前一个进程或设置 `-Dinstance.lock.enabled=false`。

## Docker 单机运行（可选）
参考 `Docker/docker-compose.yml` 自行调整端口与镜像；本项目主要通过 Web 接口管理 Napcat 容器。
