## 你的要求（约束）
- 单独新增一个类，把“查丹方”整套逻辑重新实现。
- 不在原有 DanCalculator 里做重构式修改（保持它现状可用）。

## 最小侵入接入方式
- 新增一个 Spring `@Component`（例如 `DanRecipeQueryService`），**自己负责**：命令解析、数据加载、配方推导、收益计算、输出转发消息。
- 原有 [AutoAlchemyTask.java](file:///d:/Java/qqbot/src/main/java/top/sshh/qqbot/service/liandan/AutoAlchemyTask.java#L198-L206) 的调用点从 `danCalculator.parseRecipes(...)` 改为调用新组件（这是唯一必要的接入改动，DanCalculator 不动）。
  - 如果你也希望“@ 触发”的那个入口一致，我会把两处都改成调用新组件；否则只改 startsWith 那个入口也可以。

## 新类职责与依赖
### 1) 数据加载（完全独立）
- 读取 [elixirproperties.txt](file:///d:/Java/qqbot/properties/elixirproperties.txt)：
  - 解析药材列表为 `List<Herb>`（复用现有 `top.sshh.qqbot.data.Herb`）
  - 解析丹药列表为 `Map<String, Dan>`（复用现有 `top.sshh.qqbot.data.Dan`）
- 读取 `properties/丹药坊市价值.txt`、`properties/丹药炼金价值.txt` 建两个 Map（用于兜底价格/类型判断）。
- 做缓存：首次加载后驻内存；可选加一个“文件最后修改时间”检测，变更时自动热加载（避免每次查都读文件）。

### 2) 定价与收益计算（数据化，不写死集合）
- 坊市模式：优先 `productPriceResponse.getFirstByNameOrderByTimeDesc(danName)`，若没有价格则回退 `丹药坊市价值.txt`。
- 炼金模式：用 `丹药炼金价值.txt`。
- 模式判定：
  - 如果 `丹药坊市价值.txt` 里存在该丹且价值>0，则视为坊市丹；
  - 否则视为炼金丹。
  - 这样就不再需要 `MAKE_DAN_SET`。

### 3) 配方生成（按属性推导，避免“文本丹方写错”）
- 对目标丹 `Dan.requirements`（通常是 2 条需求：如 生息/养气）：
  - 分别尝试两种分配：
    - 主药满足需求1、辅药满足需求2
    - 主药满足需求2、辅药满足需求1
- 枚举候选：
  - 主药从所有药材中过滤 `main.mainAttr2Type == mainNeedType`
  - 辅药过滤 `assist.assistAttrType == assistNeedType`
  - 药引按现有平衡规则：
    - 性平：leadCount=1 且 lead.leadAttrType 必须性平
    - 性寒/性热：lead.leadAttrType 与 main.mainAttr1Type 对冲，且 leadCount 满足整除条件
- 计算每条候选的：主药/药引/辅药数量、成本、收益（按成丹数）与利润。
- 利润降序排序，返回前 20 条。

### 4) 命令解析（修掉 substring(3) 的脆弱点）
- 支持以下输入：
  - `查丹方极品创世丹`
  - `查丹方 极品创世丹`
  - `查丹方 极品创世丹 6`
  - 带 @ 的场景（AutoAlchemyTask 传入 message 原文时也能解析）
- 解析策略：显式去掉前缀“查丹方”，trim 后把末尾数字当成成丹数（不存在则默认 6）。

## 输出格式（保持你现有体验）
- 用 `group.sendGroupForwardMessage(...)` 发转发：
  - 第一条：丹名、价格来源(坊市/炼金)、成丹数、Top 20 配方（含成本/收益/利润）
  - 第二条：提示“已按收益排序”“价格仅供参考”等。

## 验证方式（不依赖真实群）
- 增加一个简单的单元测试/本地测试入口：
  - 读取 `properties/elixirproperties.txt` 成功；
  - 查询“极品创世丹/九天蕴仙丹”至少能生成非空候选（如果价格缺失则利润可能为负，但应有配方）。
  - 验证“极品创世丹”不会再返回“九天蕴仙丹”的配方文本（因为不再读 `丹方查询.txt`，而是按丹名找 Dan）。

## 实施文件清单（预计新增/微改）
- 新增：`top.sshh.qqbot.service.liandan.DanRecipeQueryService`（或类似命名）
- 可能新增：一个小的测试类（按项目现有测试框架来定）
- 微改：AutoAlchemyTask 里 `查丹方` 的调用点改为调用新服务（不改 DanCalculator）。

如果你确认这个方案，我会开始写新类并把 AutoAlchemyTask 的“查丹方”入口切到新实现。